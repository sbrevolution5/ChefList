@page "/supplies"
@inject IApiService _api
@inject IDialogService _dialogService
@inject IUserService _userService
@if (Supplies is null)
{
    <div class="d-flex align-center justify-center">
        <Loader />
    </div>
}
else
{
    <MudCard>
        <MudCardHeader>
            <MudText Typo="Typo.h3">Supplies</MudText>
            <MudFab Color="Color.Primary" Icon="@Icons.Material.Filled.Add" aria-label="add" OnClick="NewSupply" />
            <MudButton Color="Color.Primary" Variant="Variant.Filled" aria-label="add" OnClick="SaveMySupplies">Save My Supplies</MudButton>
        </MudCardHeader>
        <MudCardContent>
            <MudGrid>
                @foreach (var supply in Supplies)
                {
                    <MudItem xs="12" sm="6" md="4" lg="3">
                        <MudPaper Elevation="2" Style="padding-left:5px;margin:10px;">
                            <MudGrid>
                                <MudItem xs="8">
                                    <MudHidden IsHidden="Auth">

                                        <MudCheckBox CheckedChanged="()=>UpdateUserSupplyList()" Tag="supply"></MudCheckBox>
                                    </MudHidden>
                                    <MudText>
                                        @supply.Name
                                    </MudText>
                                </MudItem>
                                <MudItem xs="4">
                                    <MudIconButton Color="Color.Warning" Variant="Variant.Filled" Icon="@Icons.Material.Filled.Edit" OnClick="@(() => EditSupply(supply))"></MudIconButton>
                                </MudItem>
                            </MudGrid>
                        </MudPaper>
                    </MudItem>
                }
            </MudGrid>
            <MudFab Color="Color.Primary" Icon="@Icons.Material.Filled.Add" aria-label="add" OnClick="NewSupply" />
        </MudCardContent>
    </MudCard>
}
@code {
    public List<Supply> Supplies { get; set; }
    public List<Supply> UserSupplies { get; set; }
    public Dictionary<Supply, bool> UserHasSupplyDict { get; set; }
    private string userId { get; set; }
    public bool Auth { get; set; }
    protected override async Task OnInitializedAsync()
    {
        userId = await _userService.GetUserIdAsync();
        Auth = !string.IsNullOrEmpty(userId);
        Supplies = await _api.GetAsync<List<Supply>>("api/supplies");
        if (Auth)
        {

            UserSupplies = await _api.GetAsync<List<Supply>>("api/supplies/user");
            foreach (var supply in Supplies)
            {
                if (UserSupplies.Contains(supply))
                {
                    UserHasSupplyDict.Add(supply, true);
                }
                else
                {
                    UserHasSupplyDict.Add(supply, false);

                }
            }
        }
        else
        {
            foreach (var supply in Supplies)
            {
                UserHasSupplyDict.Add(supply, false);
            }
        }
        base.OnInitialized();
    }
    public async Task NewSupply()
    {
        var dialog = _dialogService.Show<SupplyCreate>("New Supply");
        var result = await dialog.Result;
        if (!result.Cancelled)
        {
            Supplies = await _api.GetAsync<List<Supply>>("api/supplies");
        }
    }
    public async Task EditSupply(Supply supply)
    {
        var parameters = new DialogParameters { ["Supply"] = supply };
        var dialog = _dialogService.Show<SupplyEdit>("Edit Supply", parameters);
        var result = await dialog.Result;
        if (!result.Cancelled)
        {
            Supplies = await _api.GetAsync<List<Supply>>("api/supplies");
        }
    }
    private void UpdateUserSupplyList()
    {
        throw new NotImplementedException();
    }
    private void SaveMySupplies()
    {
        throw new NotImplementedException();
    }
}
